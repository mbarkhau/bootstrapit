stages:
  - test
  - build


lint:
  stage: test
  image: ${DOCKER_BASE_IMAGE}
  script:
    - make lint
    - make mypy
  artifacts:
    reports:
      junit:
        - reports/flake8.xml
    paths:
      - reports/mypycov/
  allow_failure: false


unit:
  stage: test
  image: ${DOCKER_BASE_IMAGE}
  script:
    - make test
  coverage: '/^(TOTAL|src).*?(\d+\%)$/'
  artifacts:
    reports:
      junit:
        - reports/pytest.xml
    paths:
      - reports/testcov/
  allow_failure: false


pages:
  stage: build
  script:
    - mkdir -p public/cov
    - mkdir -p public/mypycov
    - cp -r reports/testcov/* public/cov/
    - cp -r reports/mypycov/* public/mypycov/
  artifacts:
    paths:
      - public
  only:
    - master
